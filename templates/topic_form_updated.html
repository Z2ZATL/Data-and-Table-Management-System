{% extends 'layout.html' %}

{% block title %}{% if topic %}แก้ไขหัวข้อ{% else %}เพิ่มหัวข้อใหม่{% endif %}{% endblock %}

{% block content %}
<div class="hero-section">
    <div class="container">
        <div class="row">
            <div class="col-md-8 mx-auto text-center text-white">
                <h1 class="display-4 fw-bold mb-4">{% if topic %}แก้ไขหัวข้อ{% else %}เพิ่มหัวข้อใหม่{% endif %}</h1>
                <p class="lead mb-0">{% if topic %}แก้ไขรายละเอียดและเนื้อหาของหัวข้อ{% else %}เพิ่มหัวข้อใหม่สำหรับหน้าแรก{% endif %}</p>
            </div>
        </div>
    </div>
</div>

<div class="container my-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            {% if error %}
            <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
                {{ error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}
            
            <div class="card shadow-lg">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ข้อมูลหัวข้อ</h5>
                    <a href="{{ url_for('topics') }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-1"></i> กลับไปหน้ารายการ
                    </a>
                </div>
                <div class="card-body">
                    <form method="post" action="{% if topic %}{{ url_for('edit_topic', topic_id=topic.id) }}{% else %}{{ url_for('add_topic') }}{% endif %}">
                        <div class="mb-4">
                            <label for="title" class="form-label">ชื่อหัวข้อ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title" name="title" value="{{ topic.title if topic else title if title else '' }}" required>
                            <div class="form-text">ตั้งชื่อหัวข้อให้กระชับและเข้าใจง่าย</div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="description" class="form-label">คำอธิบาย</label>
                            <textarea class="form-control" id="description" name="description" rows="3">{{ topic.description if topic else description if description else '' }}</textarea>
                            <div class="form-text">อธิบายเพิ่มเติมเกี่ยวกับหัวข้อนี้ (ไม่บังคับ)</div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="fas fa-save me-1"></i> บันทึก
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            {% if topic and contents %}
            <div class="card shadow-lg mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">เนื้อหาภายในหัวข้อ</h5>
                </div>
                <div class="card-body">
                    <!-- แท็บสำหรับเลือกประเภทเนื้อหา -->
                    <ul class="nav nav-tabs mb-4" id="contentTypeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="simple-tab" data-bs-toggle="tab" data-bs-target="#simple-content" type="button" role="tab">
                                <i class="fas fa-align-left me-1"></i> เนื้อหาทั่วไป
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="table-tab" data-bs-toggle="tab" data-bs-target="#table-content" type="button" role="tab">
                                <i class="fas fa-table me-1"></i> ข้อมูลตาราง
                            </button>
                        </li>
                    </ul>
                    
                    <!-- เนื้อหาของแท็บ -->
                    <div class="tab-content" id="contentTypeTabsContent">
                        <!-- แท็บเนื้อหาทั่วไป -->
                        <div class="tab-pane fade show active" id="simple-content" role="tabpanel">
                            <form method="post" action="{{ url_for('add_topic_content', topic_id=topic.id) }}" class="mb-4">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <h6>เพิ่มเนื้อหาทั่วไป</h6>
                                    </div>
                                    <div class="col-md-9">
                                        <input type="text" class="form-control" id="content" name="content" placeholder="ใส่เนื้อหาที่ต้องการเพิ่ม" required>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="content_type" name="content_type">
                                            <option value="text" selected>ข้อความ</option>
                                            <option value="link">ลิงก์</option>
                                            <option value="highlight">ข้อความเน้น</option>
                                        </select>
                                        <input type="hidden" name="is_table" value="0">
                                    </div>
                                    <div class="col-12 text-end">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-plus-circle me-1"></i> เพิ่มเนื้อหา
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- แท็บข้อมูลตาราง -->
                        <div class="tab-pane fade" id="table-content" role="tabpanel">
                            <form method="post" action="{{ url_for('add_topic_content', topic_id=topic.id) }}" class="mb-4" id="tableForm">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <h6>เพิ่มข้อมูลตาราง</h6>
                                        <p class="text-muted small">กรอกข้อมูลในรูปแบบตารางคล้าย Excel</p>
                                    </div>
                                    
                                    <div class="col-12 mb-3">
                                        <div class="table-responsive">
                                            <table class="table table-bordered table-sm" id="dataTable">
                                                <thead>
                                                    <tr>
                                                        <th width="40px">#</th>
                                                        <th>
                                                            <input type="text" class="form-control form-control-sm table-header" 
                                                                placeholder="หัวข้อ A" data-col="0">
                                                        </th>
                                                        <th>
                                                            <input type="text" class="form-control form-control-sm table-header" 
                                                                placeholder="หัวข้อ B" data-col="1">
                                                        </th>
                                                        <th>
                                                            <input type="text" class="form-control form-control-sm table-header" 
                                                                placeholder="หัวข้อ C" data-col="2">
                                                        </th>
                                                        <th width="80px">จัดการ</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr data-row="0">
                                                        <td>1</td>
                                                        <td>
                                                            <input type="text" class="form-control form-control-sm table-cell" 
                                                                placeholder="ข้อมูล" data-row="0" data-col="0">
                                                        </td>
                                                        <td>
                                                            <input type="text" class="form-control form-control-sm table-cell" 
                                                                placeholder="ข้อมูล" data-row="0" data-col="1">
                                                        </td>
                                                        <td>
                                                            <input type="text" class="form-control form-control-sm table-cell" 
                                                                placeholder="ข้อมูล" data-row="0" data-col="2">
                                                        </td>
                                                        <td>
                                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                                onclick="removeTableRow(this)">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <div class="col-12 mb-3">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addTableRow()">
                                            <i class="fas fa-plus me-1"></i> เพิ่มแถว
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="addTableColumn()">
                                            <i class="fas fa-columns me-1"></i> เพิ่มคอลัมน์
                                        </button>
                                    </div>
                                    
                                    <input type="hidden" name="content_type" value="table">
                                    <input type="hidden" name="is_table" value="1">
                                    <input type="hidden" name="table_data" id="tableDataField">
                                    
                                    <div class="col-12 text-end">
                                        <button type="button" class="btn btn-primary" onclick="submitTableData()">
                                            <i class="fas fa-save me-1"></i> บันทึกตาราง
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <hr>
                    
                    {% if contents %}
                    <h6 class="mb-3">เนื้อหาทั้งหมด ({{ contents|length }})</h6>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">เนื้อหา</th>
                                    <th scope="col">ประเภท</th>
                                    <th scope="col">วันที่เพิ่ม</th>
                                    <th scope="col">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for content in contents %}
                                <tr>
                                    <th scope="row">{{ loop.index }}</th>
                                    <td>{{ content.content | truncate(50) }}</td>
                                    <td>
                                        {% if content.content_type == 'text' %}
                                            <span class="badge bg-secondary">ข้อความ</span>
                                        {% elif content.content_type == 'link' %}
                                            <span class="badge bg-primary">ลิงก์</span>
                                        {% elif content.content_type == 'highlight' %}
                                            <span class="badge bg-warning">ข้อความเน้น</span>
                                        {% elif content.content_type == 'table' %}
                                            <span class="badge bg-info">ตารางข้อมูล</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ content.content_type }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ content.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                                    <td>
                                        <a href="{{ url_for('delete_topic_content', content_id=content.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('คุณต้องการลบเนื้อหานี้หรือไม่?')">
                                            <i class="fas fa-trash-alt me-1"></i> ลบ
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-info-circle fa-2x mb-3 text-secondary"></i>
                        <p>ยังไม่มีเนื้อหาในหัวข้อนี้ เพิ่มเนื้อหาแรกของคุณเลย</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ตัวแปรสำหรับเก็บจำนวนแถวและคอลัมน์ปัจจุบัน
    let currentRowCount = 1;
    let currentColCount = 3;
    
    // เพิ่มแถวใหม่ในตาราง
    function addTableRow() {
        const tbody = document.querySelector('#dataTable tbody');
        const newRow = document.createElement('tr');
        newRow.setAttribute('data-row', currentRowCount);
        
        let rowHtml = `<td>${currentRowCount + 1}</td>`;
        
        // สร้าง input สำหรับแต่ละคอลัมน์
        for (let i = 0; i < currentColCount; i++) {
            rowHtml += `
            <td>
                <input type="text" class="form-control form-control-sm table-cell" 
                   placeholder="ข้อมูล" data-row="${currentRowCount}" data-col="${i}">
            </td>`;
        }
        
        // เพิ่มปุ่มลบแถว
        rowHtml += `
        <td>
            <button type="button" class="btn btn-sm btn-outline-danger" 
               onclick="removeTableRow(this)">
                <i class="fas fa-times"></i>
            </button>
        </td>`;
        
        newRow.innerHTML = rowHtml;
        tbody.appendChild(newRow);
        
        currentRowCount++;
    }
    
    // เพิ่มคอลัมน์ใหม่ในตาราง
    function addTableColumn() {
        const table = document.getElementById('dataTable');
        const headerRow = table.querySelector('thead tr');
        const dataRows = table.querySelectorAll('tbody tr');
        
        // เพิ่มหัวข้อคอลัมน์ใหม่
        const newHeader = document.createElement('th');
        newHeader.innerHTML = `
        <input type="text" class="form-control form-control-sm table-header" 
            placeholder="หัวข้อ ${String.fromCharCode(65 + currentColCount)}" data-col="${currentColCount}">
        `;
        
        // แทรกหัวข้อคอลัมน์ก่อนคอลัมน์จัดการ
        headerRow.insertBefore(newHeader, headerRow.lastElementChild);
        
        // เพิ่มเซลล์ในทุกแถวข้อมูล
        dataRows.forEach((row, index) => {
            const newCell = document.createElement('td');
            newCell.innerHTML = `
            <input type="text" class="form-control form-control-sm table-cell" 
                placeholder="ข้อมูล" data-row="${index}" data-col="${currentColCount}">
            `;
            row.insertBefore(newCell, row.lastElementChild);
        });
        
        currentColCount++;
    }
    
    // ลบแถวออกจากตาราง
    function removeTableRow(button) {
        const row = button.closest('tr');
        const tbody = row.parentElement;
        
        // ตรวจสอบว่ามีแถวมากกว่า 1 แถวหรือไม่
        if (tbody.children.length > 1) {
            row.remove();
            
            // ปรับตัวเลขลำดับแถว
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                row.setAttribute('data-row', index);
                row.firstElementChild.textContent = index + 1;
                
                // ปรับค่า data-row ของ input ทุกตัวในแถว
                const inputs = row.querySelectorAll('.table-cell');
                inputs.forEach(input => {
                    input.setAttribute('data-row', index);
                });
            });
            
            currentRowCount = rows.length;
        } else {
            alert('ต้องมีอย่างน้อย 1 แถวในตาราง');
        }
    }
    
    // บันทึกข้อมูลตาราง
    function submitTableData() {
        // เก็บข้อมูลในรูปแบบ JSON
        const tableData = {
            headers: [],
            rows: []
        };
        
        // ดึงข้อมูลหัวข้อ
        const headers = document.querySelectorAll('.table-header');
        headers.forEach(header => {
            tableData.headers.push(header.value || header.placeholder);
        });
        
        // ดึงข้อมูลเซลล์
        const rows = document.querySelectorAll('#dataTable tbody tr');
        rows.forEach(row => {
            const rowData = [];
            const cells = row.querySelectorAll('.table-cell');
            cells.forEach(cell => {
                rowData.push(cell.value || '');
            });
            tableData.rows.push(rowData);
        });
        
        // กำหนดค่าให้กับ input hidden
        document.getElementById('tableDataField').value = JSON.stringify(tableData);
        
        // ส่งฟอร์ม
        document.getElementById('tableForm').submit();
    }
</script>
{% endblock %}