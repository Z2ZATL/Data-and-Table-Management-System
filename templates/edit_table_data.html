{% extends 'layout.html' %}

{% block title %}แก้ไขข้อมูลตาราง{% endblock %}

{% block content %}
<div class="hero-section">
    <div class="container">
        <div class="row">
            <div class="col-md-8 col-lg-6 mx-auto text-center text-white">
                <h1 class="display-4 fw-bold mb-4">แก้ไขข้อมูลตาราง</h1>
                <p class="lead mb-4">จัดการและแก้ไขข้อมูลในตารางของคุณ</p>
            </div>
        </div>
    </div>
</div>

<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-lg mb-5">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i> {% if is_new %}สร้างข้อมูลตารางใหม่{% else %}แก้ไขตารางข้อมูล: {{ data_name }}{% endif %}
                    </h5>
                    <div>
                        <a href="/data" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-arrow-left me-1"></i> กลับ
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if error %}
                        <div class="alert alert-danger mb-4">
                            <i class="fas fa-exclamation-triangle me-2"></i> {{ error }}
                        </div>
                    {% endif %}
                    
                    {% if success %}
                        <div class="alert alert-success mb-4">
                            <i class="fas fa-check-circle me-2"></i> {{ success }}
                        </div>
                    {% endif %}
                    
                    {% if not is_new %}
                    <div class="mb-4">
                        <p class="mb-2">
                            <i class="fas fa-info-circle me-2 text-primary"></i> <strong>คำอธิบาย:</strong> 
                            {{ description or 'ไม่มีคำอธิบาย' }}
                        </p>
                        <p class="mb-0 small">
                            <i class="fas fa-clock me-1"></i> สร้างเมื่อ: {{ created_at.strftime('%d/%m/%Y %H:%M') if created_at else '-' }} | 
                            <i class="fas fa-edit me-1"></i> แก้ไขล่าสุด: {{ updated_at.strftime('%d/%m/%Y %H:%M') if updated_at else '-' }}
                        </p>
                    </div>
                    {% endif %}
                    
                    <form id="tableForm" action="{% if is_new %}/data/add-table{% else %}/data/edit-table/{{ content_id }}{% endif %}" method="POST">
                        <div class="mb-4">
                            <label for="data_name" class="form-label">ชื่อตารางข้อมูล <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="data_name" name="data_name" value="{{ data_name or content_name or '' }}" placeholder="เช่น ราคาทอง, อัตราเงินเฟ้อ, ยอดขาย" required>
                            <small class="form-text text-muted">ระบุชื่อสำหรับตารางข้อมูลนี้เพื่อให้ง่ายต่อการอ้างอิง</small>
                        </div>
                        
                        <div class="table-responsive mb-4">
                            <table class="table table-bordered table-hover" id="editable_table">
                                <thead class="table-light">
                                    <tr id="header_row">
                                        {% for header in table_data.headers %}
                                        <th class="position-relative">
                                            <input type="text" class="form-control form-control-sm header-cell" 
                                                  value="{{ header }}" placeholder="ชื่อคอลัมน์" required>
                                            {% if table_data.headers|length > 1 %}
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-column position-absolute top-0 end-0 m-1" style="font-size: 0.7rem; width: 20px; height: 20px; padding: 0; border-radius: 50%;">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            {% endif %}
                                        </th>
                                        {% endfor %}
                                        <th style="width: 100px;">
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="add_column">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in table_data.rows %}
                                    <tr>
                                        {% for cell in row %}
                                        <td>
                                            <input type="text" class="form-control form-control-sm data-cell" 
                                                  value="{{ cell }}" placeholder="ข้อมูล">
                                        </td>
                                        {% endfor %}
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-row">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mb-4">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="add_row">
                                <i class="fas fa-plus me-1"></i> เพิ่มแถว
                            </button>
                        </div>
                        
                        <input type="hidden" name="table_data" id="table_data">
                        
                        <div class="d-flex justify-content-between mt-4">
                            <a href="/data" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i> ยกเลิก
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> บันทึกการเปลี่ยนแปลง
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ปุ่มเพิ่มคอลัมน์
        const addColumnBtn = document.getElementById('add_column');
        const headerRow = document.getElementById('header_row');
        
        addColumnBtn.addEventListener('click', function() {
            const newHeader = document.createElement('th');
            newHeader.innerHTML = `<input type="text" class="form-control form-control-sm header-cell" placeholder="ชื่อคอลัมน์" required>`;
            
            // แทรกคอลัมน์ใหม่ก่อนปุ่ม
            headerRow.insertBefore(newHeader, headerRow.lastElementChild);
            
            // เพิ่มเซลล์ในแต่ละแถวข้อมูล
            const dataRows = document.querySelectorAll('#editable_table tbody tr');
            dataRows.forEach(row => {
                const newCell = document.createElement('td');
                newCell.innerHTML = `<input type="text" class="form-control form-control-sm data-cell" placeholder="ข้อมูล">`;
                row.insertBefore(newCell, row.lastElementChild);
            });
        });
        
        // ปุ่มเพิ่มแถว
        const addRowBtn = document.getElementById('add_row');
        const tableBody = document.querySelector('#editable_table tbody');
        
        addRowBtn.addEventListener('click', function() {
            const headerColumns = headerRow.cells.length - 1; // ไม่รวมคอลัมน์ปุ่ม
            const newRow = document.createElement('tr');
            
            for (let i = 0; i < headerColumns; i++) {
                const cell = document.createElement('td');
                cell.innerHTML = `<input type="text" class="form-control form-control-sm data-cell" placeholder="ข้อมูล">`;
                newRow.appendChild(cell);
            }
            
            // เพิ่มปุ่มลบแถว
            const actionCell = document.createElement('td');
            actionCell.innerHTML = `<button type="button" class="btn btn-sm btn-outline-danger remove-row">
                                      <i class="fas fa-times"></i>
                                   </button>`;
            newRow.appendChild(actionCell);
            
            tableBody.appendChild(newRow);
            
            // เพิ่ม event listener สำหรับปุ่มลบแถวที่เพิ่มใหม่
            attachRemoveRowEvents();
        });
        
        // ฟังก์ชันเพิ่ม event listener สำหรับปุ่มลบแถว
        function attachRemoveRowEvents() {
            const removeButtons = document.querySelectorAll('.remove-row');
            removeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // ตรวจสอบจำนวนแถวทั้งหมดที่มีอยู่
                    const allRows = tableBody.querySelectorAll('tr');
                    
                    // ถ้ามีเพียงแถวเดียว จะไม่อนุญาตให้ลบ
                    if (allRows.length <= 1) {
                        alert('ต้องมีอย่างน้อย 1 แถวในตาราง');
                        return;
                    }
                    
                    // ถ้ามีมากกว่า 1 แถว สามารถลบได้
                    this.closest('tr').remove();
                });
            });
        }
        
        // เรียกใช้ฟังก์ชันเพื่อเพิ่ม event listener แรกเริ่ม
        attachRemoveRowEvents();
        
        // ฟังก์ชันเพิ่ม event listener สำหรับปุ่มลบคอลัมน์
        function attachRemoveColumnEvents() {
            const removeColumnButtons = document.querySelectorAll('.remove-column');
            removeColumnButtons.forEach((button, index) => {
                button.addEventListener('click', function() {
                    // ตรวจสอบว่ามีมากกว่า 1 คอลัมน์หรือไม่
                    const headerCells = headerRow.querySelectorAll('th');
                    if (headerCells.length <= 2) { // รวมคอลัมน์ปุ่มด้วย
                        alert('ต้องมีอย่างน้อย 1 คอลัมน์ในตาราง');
                        return;
                    }
                    
                    // หาลำดับของคอลัมน์
                    const columnIndex = Array.from(headerRow.children).indexOf(this.closest('th'));
                    
                    // ลบ header
                    headerRow.children[columnIndex].remove();
                    
                    // ลบข้อมูลในแต่ละแถว
                    const rows = document.querySelectorAll('#editable_table tbody tr');
                    rows.forEach(row => {
                        row.children[columnIndex].remove();
                    });
                });
            });
        }
        
        // เรียกใช้ฟังก์ชันลบคอลัมน์
        attachRemoveColumnEvents();
        
        // เพิ่ม event listener สำหรับคอลัมน์ใหม่
        addColumnBtn.addEventListener('click', function() {
            // หลังจากเพิ่มคอลัมน์ใหม่
            setTimeout(() => {
                const newColumnButton = document.createElement('button');
                newColumnButton.className = 'btn btn-sm btn-outline-danger remove-column position-absolute top-0 end-0 m-1';
                newColumnButton.style.cssText = 'font-size: 0.7rem; width: 20px; height: 20px; padding: 0; border-radius: 50%;';
                newColumnButton.innerHTML = '<i class="fas fa-times"></i>';
                
                // เพิ่มปุ่มลบในคอลัมน์ที่เพิ่มใหม่
                const newColumn = headerRow.children[headerRow.children.length - 2]; // ก่อนคอลัมน์ปุ่มสุดท้าย
                newColumn.classList.add('position-relative');
                newColumn.appendChild(newColumnButton);
                
                // เพิ่ม event listener
                attachRemoveColumnEvents();
            }, 100);
        });
        
        // รวบรวมข้อมูลตารางก่อนส่งฟอร์ม
        const form = document.getElementById('tableForm');
        const tableDataInput = document.getElementById('table_data');
        
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // อ่านข้อมูลส่วนหัวตาราง
            const headers = [];
            const headerInputs = document.querySelectorAll('.header-cell');
            headerInputs.forEach(input => {
                headers.push(input.value || '');
            });
            
            // ตรวจสอบว่ามีส่วนหัวครบทุกช่องหรือไม่
            const emptyHeaders = headers.filter(h => h.trim() === '');
            if (emptyHeaders.length > 0) {
                alert('กรุณากรอกชื่อคอลัมน์ให้ครบทุกช่อง');
                return;
            }
            
            // อ่านข้อมูลในตาราง
            const rows = [];
            const dataRows = document.querySelectorAll('#editable_table tbody tr');
            
            dataRows.forEach(row => {
                const rowData = [];
                const cells = row.querySelectorAll('.data-cell');
                cells.forEach(cell => {
                    rowData.push(cell.value || '');
                });
                rows.push(rowData);
            });
            
            // เก็บข้อมูลในฟิลด์ซ่อน
            const tableData = {
                headers: headers,
                rows: rows
            };
            
            tableDataInput.value = JSON.stringify(tableData);
            
            // ส่งฟอร์ม
            form.submit();
        });
    });
</script>
{% endblock %}