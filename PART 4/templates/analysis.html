<!DOCTYPE html>  <!-- ประกาศว่าเป็นไฟล์ HTML -->
<html>
<head>
  <meta charset="UTF-8">  <!-- กำหนดการเข้ารหัสเป็น UTF-8 -->
  <title>Data Analysis</title>  <!-- ชื่อของหน้าเว็บ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  <!-- นำเข้า Chart.js สำหรับสร้างกราฟ -->
</head>
<body>
  <h1>Data Analysis</h1>  <!-- หัวข้อของหน้า -->

  <!-- Dropdown Filter สำหรับเลือกเพศ -->
  <label>Filter by Gender:</label>
  <select id="genderFilter">
    <option value="All">All</option>
    <option value="ชาย">ชาย</option>
    <option value="หญิง">หญิง</option>
  </select>

  <!-- Dropdown Filter สำหรับเลือกช่วงอายุ -->
  <label>Filter by Age Range:</label>
  <select id="ageFilter">
    <option value="All">All</option>
    <option value="0-20">0-20</option>
    <option value="21-40">21-40</option>
    <option value="41+">41+</option>
  </select>

  <!-- Canvas สำหรับแสดงกราฟ Pie Chart -->
  <canvas id="provinceChart" width="400" height="400"></canvas>

  <script>
    // นำข้อมูลผู้ใช้จาก Flask มาที่ JavaScript
    const users = {{ users|tojson }};  // แปลงข้อมูล Python เป็น JSON

    // นำค่า dropdown สำหรับเพศและช่วงอายุ
    const genderSelect = document.getElementById("genderFilter");
    const ageSelect = document.getElementById("ageFilter");

    // ฟังก์ชันที่ใช้กรองข้อมูลตามเพศและช่วงอายุ
    function filterData(gender, ageRange) {
      return users.filter(user => {
        const passGender = gender === "All" || user.gender === gender;  // กรองตามเพศ
        const age = parseInt(user.age);  // แปลงอายุเป็นตัวเลข
        let passAge = true;
        // กรองตามช่วงอายุ
        if (ageRange === "0-20") passAge = age >= 0 && age <= 20;
        else if (ageRange === "21-40") passAge = age >= 21 && age <= 40;
        else if (ageRange === "41+") passAge = age > 40;
        return passGender && passAge;  // ถ้าผ่านทั้งสองเกณฑ์
      });
    }

    // ฟังก์ชันที่ใช้ในการนับจำนวนคนในแต่ละจังหวัด
    function countByProvince(data) {
      const counts = {};  // สร้างอ็อบเจกต์เพื่อเก็บจำนวนคนในแต่ละจังหวัด
      data.forEach(user => {
        counts[user.province] = (counts[user.province] || 0) + 1;  // นับจำนวนคนในจังหวัดนั้น
      });
      return counts;
    }

    // ฟังก์ชันที่ใช้ในการอัปเดตกราฟ
    function updateChart(chart, data) {
      const provinceCounts = countByProvince(data);  // นับจำนวนคนในแต่ละจังหวัด
      chart.data.labels = Object.keys(provinceCounts);  // ตั้งชื่อแท็กของกราฟ
      chart.data.datasets[0].data = Object.values(provinceCounts);  // ตั้งค่าข้อมูลในกราฟ
      chart.update();  // อัปเดตกราฟ
    }

    // สร้างกราฟ Pie Chart
    const ctx = document.getElementById('provinceChart').getContext('2d');  // เลือกตำแหน่งสำหรับแสดงกราฟ
    const provinceChart = new Chart(ctx, {
      type: 'pie',  // ประเภทของกราฟคือ Pie Chart
      data: {
        labels: [],  // แท็กของกราฟ
        datasets: [{
          label: 'จำนวนคนในแต่ละจังหวัด',  // ชื่อกราฟ
          data: [],  // ข้อมูลในกราฟ
          backgroundColor: [  // สีพื้นหลังของกราฟ
            'rgba(255, 99, 132, 0.6)',
            'rgba(54, 162, 235, 0.6)',
            'rgba(255, 206, 86, 0.6)',
            'rgba(75, 192, 192, 0.6)',
            'rgba(153, 102, 255, 0.6)',
            'rgba(255, 159, 64, 0.6)',
            'rgba(201, 203, 207, 0.6)'
          ]
        }]
      }
    });

    // ฟังก์ชันที่ใช้ในการจัดการเมื่อมีการเลือกตัวกรอง
    function handleFilterChange() {
      const selectedGender = genderSelect.value;  // รับค่าจากตัวเลือกเพศ
      const selectedAge = ageSelect.value;  // รับค่าจากตัวเลือกช่วงอายุ
      const filtered = filterData(selectedGender, selectedAge);  // กรองข้อมูล
      updateChart(provinceChart, filtered);  // อัปเดตกราฟ
    }

    // เพิ่ม event listeners ให้กับ dropdown filters
    genderSelect.addEventListener("change", handleFilterChange);
    ageSelect.addEventListener("change", handleFilterChange);

    handleFilterChange();  // แสดงกราฟครั้งแรก
  </script>
</body>
</html>
